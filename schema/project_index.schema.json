{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/kpblcaoo/cd-index/schema/project_index.schema.json",
  "title": "CD Index Project Schema",
  "description": "Schema for cd-index project structure and dependency flows",
  "type": "object",
  "required": ["Meta", "Project", "Tree", "DI", "Entrypoints", "MessageFlow", "Callgraphs", "Configs", "Commands", "CliCommands", "Tests"],
  "properties": {
    "Meta": {
      "type": "object",
      "required": ["GeneratedAt", "Version", "SchemaVersion"],
      "properties": {
        "GeneratedAt": {
          "type": "string",
          "format": "date-time",
          "description": "UTC ISO-8601 timestamp when index was generated"
        },
        "Version": {
          "type": "string",
          "description": "Version of the cd-index tool"
        },
        "SchemaVersion": {
          "type": "string",
          "const": "1.1",
          "description": "Schema version (current: 1.1)"
        },
        "RepositoryUrl": {
          "type": ["string", "null"],
          "description": "URL of the repository being indexed"
        }
      },
      "additionalProperties": false
    },
    "Project": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["Name", "Path"],
        "properties": {
          "Name": {
            "type": "string",
            "description": "Project name"
          },
          "Path": {
            "type": "string",
            "description": "Normalized path to project file"
          },
          "Framework": {
            "type": ["string", "null"],
            "description": "Target framework"
          },
          "Language": {
            "type": ["string", "null"],
            "description": "Programming language"
          }
        },
        "additionalProperties": false
      }
    },
    "Tree": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["Files"],
        "properties": {
          "Files": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["Path", "Sha256", "Loc", "Kind"],
              "properties": {
                "Path": {
                  "type": "string",
                  "description": "Normalized file path relative to repository root"
                },
                "Sha256": {
                  "type": "string",
                  "pattern": "^[a-f0-9]{64}$",
                  "description": "SHA256 hash of file content"
                },
                "Loc": {
                  "type": "integer",
                  "minimum": 0,
                  "description": "Lines of code count"
                },
                "Kind": {
                  "type": "string",
                  "description": "File type/kind"
                }
              },
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      }
    },
    "DI": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["Registrations", "HostedServices"],
        "properties": {
          "Registrations": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["Interface", "Implementation", "Lifetime", "File", "Line"],
              "properties": {
                "Interface": {
                  "type": "string",
                  "description": "Service interface or type being registered"
                },
                "Implementation": {
                  "type": "string",
                  "description": "Implementation type or factory description"
                },
                "Lifetime": {
                  "type": "string",
                  "enum": ["Transient", "Scoped", "Singleton"],
                  "description": "Service lifetime"
                },
                "File": {
                  "type": "string",
                  "description": "Repo-relative file path with forward slashes"
                },
                "Line": {
                  "type": "integer",
                  "minimum": 1,
                  "description": "Line number (1-based)"
                }
              },
              "additionalProperties": false
            }
          },
          "HostedServices": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["Type", "File", "Line"],
              "properties": {
                "Type": {
                  "type": "string",
                  "description": "Hosted service type name"
                },
                "File": {
                  "type": "string",
                  "description": "Repo-relative file path with forward slashes"
                },
                "Line": {
                  "type": "integer",
                  "minimum": 1,
                  "description": "Line number (1-based)"
                }
              },
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      }
    },
    "Entrypoints": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["Project", "ProgramMain", "HostedServices"],
        "properties": {
          "Project": {
            "type": "object",
            "required": ["Name", "File"],
            "properties": {
              "Name": { "type": "string", "description": "Project name" },
              "File": { "type": "string", "description": "Repo-relative path to project file" }
            },
            "additionalProperties": false
          },
          "ProgramMain": {
            "type": ["object", "null"],
            "required": ["File", "Line"],
            "properties": {
              "File": { "type": "string", "description": "Repo-relative file path" },
              "Line": { "type": "integer", "minimum": 1, "description": "Line number (1-based)" },
              "TypeName": { "type": ["string", "null"], "description": "Fully qualified type name of Program class" }
            },
            "additionalProperties": false
          },
          "HostedServices": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["Type", "File", "Line"],
              "properties": {
                "Type": { "type": "string", "description": "Hosted service type name" },
                "File": { "type": "string", "description": "Repo-relative file path" },
                "Line": { "type": "integer", "minimum": 1, "description": "Line number (1-based)" }
              },
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      }
    },
    "MessageFlow": {
      "type": "array",
      "description": "Message flow analysis",
      "items": {
        "type": "object",
        "required": ["Nodes"],
        "properties": {
          "Nodes": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["Order", "Kind", "Detail", "File", "Line"],
              "properties": {
                "Order": { "type": "integer", "minimum": 0 },
                "Kind": { "type": "string", "enum": ["guard", "delegate", "return", "other" ] },
                "Detail": { "type": "string" },
                "File": { "type": "string" },
                "Line": { "type": "integer", "minimum": 1 }
              },
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      }
    },
    "Callgraphs": {
      "type": "array",
      "description": "Call graph analysis (future extension)"
    },
    "Configs": {
      "type": "array",
      "description": "Configuration analysis",
      "items": {
        "type": "object",
        "required": ["EnvKeys", "AppProps"],
        "properties": {
          "EnvKeys": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Sorted unique environment variable keys discovered"
          },
          "AppProps": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Sorted unique application config properties in form Type.Property"
          }
        },
        "additionalProperties": false
      }
    },
    "Commands": {
      "type": "array",
      "description": "Command analysis",
      "items": {
        "type": "object",
        "required": ["Items"],
        "properties": {
          "Items": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["Command", "File", "Line"],
              "properties": {
                "Command": { "type": "string", "description": "Chat command text incl. leading slash" },
                "Handler": { "type": ["string", "null"], "description": "Resolved handler type/name if any" },
                "File": { "type": "string", "description": "Repo-relative file path" },
                "Line": { "type": "integer", "minimum": 1, "description": "Line number (1-based)" }
              },
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      }
    },
    "CliCommands": {
      "type": "array",
      "description": "System.CommandLine command model analysis",
      "items": {
        "type": "object",
        "required": ["Command", "Aliases", "Options", "Arguments", "File", "Line"],
        "properties": {
          "Command": { "type": "string", "description": "Primary command name" },
          "Aliases": { "type": "array", "items": { "type": "string" }, "description": "Alternate names" },
          "Options": { "type": "array", "items": { "type": "string" }, "description": "Option tokens (e.g. --help)" },
          "Arguments": { "type": "array", "items": { "type": "string" }, "description": "Positional argument names" },
          "File": { "type": "string", "description": "Repo-relative file path" },
          "Line": { "type": "integer", "minimum": 1, "description": "Line number (1-based)" }
        },
        "additionalProperties": false
      }
    },
    "Tests": {
      "type": "array",
      "description": "Test analysis (future extension)"
    }
  },
  "additionalProperties": false
}
